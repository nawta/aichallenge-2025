# Development Log - 2025/12/17

## Overview

Fixed `train_all_models.sh` temporal model training failures and implemented full BEV (Bird's Eye View) model support for TinyLidarNet training pipeline.

---

## Issue Analysis

### Problem
- `train_all_models.sh` was failing for temporal models (TinyLidarNetStacked, BiLSTM, TCN)
- Single-frame models succeeded (1200-2700s each)
- Temporal models failed immediately (1-2s each, "No best_model.pth found")

### Root Cause
**Error:** `train.py: error: unrecognized arguments: --seq-len 10 --hidden-size 128`

The script mixed Hydra configuration format (dot notation) with CLI flags:
```bash
# WRONG - mixed formats
EXTRA_ARGS="model.seq_len=10 --seq-len 10"
```

`train.py` uses Hydra which only accepts dot-notation overrides, not CLI flags.

---

## Fixes Applied

### Commit 1: Priority 1 & 2 Fixes (2408bf5)

#### 1. config/train.yaml
- Changed `input_dim: 750` → `input_dim: 1080` to match model defaults

#### 2. convert_weight.py
- Added `--tcn-causal` argument for TCN model inference mode

#### 3. train_all_models.sh
- **Key Fix:** Separated train args from convert args:
  ```bash
  train_model() {
      local TRAIN_EXTRA_ARGS=$4    # Hydra overrides for train.py
      local CONVERT_EXTRA_ARGS=$5  # CLI args for convert_weight.py
  }
  ```
- For temporal models:
  ```bash
  TRAIN_EXTRA="model.seq_len=${SEQ_LEN} model.hidden_size=${HIDDEN_SIZE}"
  CONVERT_EXTRA="--seq-len ${SEQ_LEN} --hidden-size ${HIDDEN_SIZE}"
  ```

#### 4. Added TinyLidarNetMap Training
- Added map model with both map images (1.png, 2.png)
- Separate checkpoint directories for each map

---

### Commit 2: BEV Model Implementation (f6a821e)

#### New Files Created

**lib/bev_generator.py**
- `BEVGenerator` class with `generate_local()`, `generate_global()`, `generate_both()` methods
- Local BEV: 64x64 grid, 2 channels (left/right boundaries), vehicle-centered, rotated to heading
- Global BEV: 128x128 grid, 3 channels (left/right/ego marker), map-fixed coordinates
- Uses Bresenham's line algorithm for efficient grid rendering
- `quaternion_to_yaw()` utility function

**lib/map_loader.py**
- `LaneBoundaries` dataclass for organized boundary data
- `load_lane_boundaries()` function to parse CSV
- `get_nearby_boundaries()` for spatial queries
- Auto/manual coordinate offset normalization

#### Modified Files

**lib/model.py** (+410 lines)
- `TinyLidarNetLocalBEV`: LiDAR (5 Conv1D) + Local BEV (3 Conv2D) + State (FC) → Late Fusion
- `TinyLidarNetGlobalBEV`: LiDAR + Global BEV (4 Conv2D) + State → Late Fusion
- `TinyLidarNetDualBEV`: LiDAR + Both BEVs + State → Late Fusion (largest model)
- All use late fusion architecture with concatenation before MLP head

**lib/data.py** (+336 lines)
- `BEVScanControlSequenceDataset`: Single sequence dataset with BEV generation
- `BEVMultiSeqConcatDataset`: Multi-sequence concatenation for BEV
- Support for `bev_mode`: 'local', 'global', or 'both'
- Mirror augmentation: flips scan, BEV horizontally, swaps left/right channels, negates steering

**train.py** (+147 lines)
- Added `BEV_MODELS` constant
- Auto-detect BEV mode from model name
- BEV-specific dataset creation with `BEVMultiSeqConcatDataset`
- BEV-specific batch unpacking in training/validation loops

**convert_weight.py** (+58 lines)
- Added BEV model choices to argparse
- Added `--local-grid-size` and `--global-grid-size` arguments
- BEV model instantiation in `load_model()`

**train_all_models.sh** (+46 lines)
- Added `BEV_MODELS` array with 3 models
- Added BEV parameters (grid sizes, resolutions, lane CSV path)
- Added BEV training section

---

## Architecture Summary

### BEV Model Architectures

```
TinyLidarNetLocalBEV:
  LiDAR (1080) → 5 Conv1D → 1792 features
  Local BEV (2x64x64) → 3 Conv2D → 256 features
  State (13) → FC → 64 features
  Concat (2112) → 4-layer MLP → 2 outputs

TinyLidarNetGlobalBEV:
  LiDAR (1080) → 5 Conv1D → 1792 features
  Global BEV (3x128x128) → 4 Conv2D → 256 features
  State (13) → FC → 64 features
  Concat (2112) → 4-layer MLP → 2 outputs

TinyLidarNetDualBEV:
  LiDAR → 1792 features
  Local BEV → 256 features
  Global BEV → 256 features
  State → 64 features
  Concat (2368) → 5-layer MLP → 2 outputs
```

### Data Flow

```
lane.csv → LaneBoundaries → BEVGenerator
                              ↓
odom.npy → (x, y, yaw) → generate_local() / generate_global()
                              ↓
                         BEV grids (CHW tensors)
                              ↓
               BEVScanControlSequenceDataset
                              ↓
                    Training pipeline
```

---

## Files Changed

| File | Lines Added | Lines Removed | Description |
|------|-------------|---------------|-------------|
| lib/bev_generator.py | 450 | 0 | New: BEV generation |
| lib/map_loader.py | 195 | 0 | New: Lane CSV loading |
| lib/model.py | 410 | 0 | BEV model classes |
| lib/data.py | 336 | 0 | BEV dataset classes |
| train.py | 147 | 51 | BEV training support |
| convert_weight.py | 58 | 0 | BEV conversion |
| train_all_models.sh | 46 | 0 | BEV training automation |
| config/train.yaml | 1 | 1 | input_dim fix |

**Total: +1689 lines**

---

## Training Configuration

### Models Available

| Category | Models | aug/noaug |
|----------|--------|-----------|
| Single-frame | TinyLidarNet, Small, Deep, Fusion | 4 × 2 = 8 |
| Temporal | Stacked, BiLSTM, TCN | 3 × 2 = 6 |
| Map | TinyLidarNetMap (×2 maps) | 1 × 2 × 2 = 4 |
| BEV | LocalBEV, GlobalBEV, DualBEV | 3 × 2 = 6 |
| **Total** | | **24 runs** |

### Key Paths
- Lane CSV: `/aichallenge/workspace/src/aichallenge_submit/laserscan_generator/map/lane.csv`
- Map images: `/aichallenge/map_image/1.png`, `/aichallenge/map_image/2.png`
- Checkpoints: `checkpoints/{ModelName}_{aug|noaug}/`
- Weights: `weights/{ModelName}_{aug|noaug}.npy`

---

## Testing Notes

### To Test Temporal Models Fix
```bash
# Should now work without "unrecognized arguments" error
python3 train.py model.name='TinyLidarNetStacked' model.seq_len=10 model.hidden_size=128
```

### To Test BEV Models
```bash
# Single BEV model
python3 train.py \
  model.name='TinyLidarNetLocalBEV' \
  model.lane_csv_path='/aichallenge/workspace/src/aichallenge_submit/laserscan_generator/map/lane.csv'

# All models overnight
./train_all_models.sh
```

---

## Next Steps

1. Run `train_all_models.sh` overnight to train all models
2. Verify temporal models now produce `best_model.pth`
3. Evaluate BEV models for performance improvement
4. Consider adding BEV visualization for debugging

---

## Git Commits

1. `2408bf5` - fix(tiny_lidar_net): separate Hydra/CLI args and add TinyLidarNetMap training
2. `f6a821e` - feat(tiny_lidar_net): add BEV model support for training
